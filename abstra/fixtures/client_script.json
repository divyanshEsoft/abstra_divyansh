[
  {
    "doctype": "Client Script",
    "dt": "Sales Order",
    "enabled": 1,
    "modified": "2025-11-20 13:00:00.000000", 
    "name": "Sales Order Fix Project Items Numbering",
    "script": "frappe.ui.form.on('Sales Order', {\n    onload: function(frm) {\n        try {\n            if (frm.doc.__islocal) {\n                frm.clear_table('items');\n                frm.refresh_field('items');\n            }\n        } catch (error) {\n            console.warn('Error in onload:', error);\n        }\n    },\n    \n    project: function(frm) {\n        if (!frm.doc.project) return;\n        \n        console.log('Project selected:', frm.doc.project);\n        \n        if (frm.custom_project_monitor) {\n            clearInterval(frm.custom_project_monitor);\n        }\n        \n        let checkCount = 0;\n        const maxChecks = 50;\n        \n        frm.custom_project_monitor = setInterval(() => {\n            try {\n                checkCount++;\n                fixItemNumbering(frm);\n                \n                if (checkCount >= maxChecks) {\n                    clearInterval(frm.custom_project_monitor);\n                    console.log('Stopped monitoring for project items');\n                }\n            } catch (error) {\n                console.warn('Error in project monitor:', error);\n                clearInterval(frm.custom_project_monitor);\n            }\n        }, 100);\n    },\n    \n    before_save: function(frm) {\n        fixItemNumbering(frm);\n    }\n});\n\nfunction fixItemNumbering(frm) {\n    if (!frm.doc.items || frm.doc.items.length === 0) return false;\n    \n    let needsRefresh = false;\n    \n    if (frm.doc.items.length > 1 && !frm.doc.items[0].item_code && frm.doc.items[1].item_code) {\n        console.log('Removing blank row and renumbering');\n        frm.doc.items.splice(0, 1);\n        needsRefresh = true;\n    }\n    \n    let numberingCorrect = true;\n    frm.doc.items.forEach((item, index) => {\n        const expectedIdx = index + 1;\n        if (item.idx !== expectedIdx) {\n            item.idx = expectedIdx;\n            numberingCorrect = false;\n        }\n    });\n    \n    if (!numberingCorrect) {\n        needsRefresh = true;\n        console.log('Fixed item numbering');\n    }\n    \n    if (needsRefresh) {\n        frm.refresh_field('items');\n        return true;\n    }\n    \n    return false;\n}"
  }
]
